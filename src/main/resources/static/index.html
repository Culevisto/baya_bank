<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baya Bank</title>
    <link rel="icon" href="/images/bank.webp" type="image/webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background 0.3s, color 0.3s;
            background-color: #F8FAFC;
            color: #0F172A;
        }
        .dark body { background-color: #0F172A; color: #F1F5F9; }

        /* –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã */
        .theme-text { color: #0F172A; transition: color 0.3s; }
        .dark .theme-text { color: #FFFFFF; }

        /* –§–ò–ö–°: –¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–∞—Ö –∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –í–°–ï–ì–î–ê –ë–ï–õ–´–ô */
        .text-fixed-white { color: #FFFFFF !important; }
        .text-fixed-white-op { color: rgba(255, 255, 255, 0.6) !important; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—á–µ—Ç–æ–≤ */
        #accounts-container {
            display: flex;
            gap: 1.25rem;
            padding: 1.5rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
        }

        .progress-bg { background: rgb(255, 255, 255); height: 8px; border-radius: 10px; margin-top: 12px; }
        .progress-fill { background: #FFFFFF; height: 100%; border-radius: 10px; }

        /* –ö–Ω–æ–ø–∫–∞ —Ç–µ–º—ã */
        .theme-btn {
            position: fixed; top: 20px; right: 20px; width: 56px; height: 56px;
            border-radius: 18px; background: #FFFFFF; z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 2px solid #E2E8F0;
        }
        .dark .theme-btn { background: #1E293B; border-color: #334155; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(12px); z-index: 1000;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-box {
            width: 100%; max-width: 500px; background: #FFFFFF;
            border-top-left-radius: 35px; border-top-right-radius: 35px;
            padding: 35px; animation: slideUp 0.3s ease-out;
        }
        .dark .modal-box { background: #1E293B; }

        .modal-input {
            background-color: #F1F5F9;
            color: #0F172A;
            border: 2px solid transparent;
        }
        .dark .modal-input {
            background-color: #334155;
            color: #FFFFFF;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –∫–∞—Ä—Ç */
        .card-gradient-1 { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
    </style>
</head>
<body class="pb-36">

<button onclick="toggleTheme()" class="theme-btn flex items-center justify-center">
    <i class="fas fa-sun text-amber-500 text-2xl dark:hidden"></i>
    <i class="fas fa-moon text-blue-400 text-2xl hidden dark:block"></i>
</button>

<div id="page-home" class="max-w-lg mx-auto">
    <header class="pt-14 px-6 mb-4">
        <h1 class="text-3xl font-black uppercase tracking-tight theme-text">–ú–æ–∏ —Å—á–µ—Ç–∞</h1>
        <p id="currentDate" class="text-slate-500 font-bold italic mt-1">...</p>
    </header>

    <div class="no-scrollbar" id="accounts-container"></div>

    <div class="px-6 mt-4">
        <h3 class="text-xl font-black uppercase mb-6 tracking-wide theme-text">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
        <div id="transactions-list" class="space-y-4"></div>
    </div>
</div>

<div id="page-stats" class="max-w-lg mx-auto hidden pt-14 px-6">
    <h1 class="text-3xl font-black uppercase mb-8 theme-text text-center">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>

    <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-[30px] shadow-lg border border-slate-100 dark:border-slate-700">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">–ó–∞—Ä–∞–±–æ—Ç–æ–∫</p>
            <p id="stat-income" class="text-xl font-black text-emerald-500">0 –°–û–ú</p>
        </div>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-[30px] shadow-lg border border-slate-100 dark:border-slate-700">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">–¢—Ä–∞—Ç—ã</p>
            <p id="stat-expense" class="text-xl font-black text-rose-500">0 –°–û–ú</p>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-800 p-8 rounded-[40px] shadow-2xl border border-slate-100 dark:border-slate-700 text-center">
        <h4 class="text-slate-400 font-black text-[10px] uppercase mb-6 tracking-[0.2em]">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
        <div class="relative h-72">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl border-t border-slate-200 dark:border-slate-800 p-6 flex justify-around items-center z-[100]">
    <button onclick="showPage('home')" class="flex flex-col items-center text-slate-400" id="nav-home">
        <i class="fas fa-wallet text-2xl"></i>
        <span class="text-[10px] font-black uppercase mt-1">–°—á–µ—Ç–∞</span>
    </button>
    <div class="flex gap-4">
        <button onclick="openModal('INCOME')" class="w-14 h-14 bg-emerald-500 text-white rounded-[20px] shadow-lg flex items-center justify-center active:scale-90 transition">
            <i class="fas fa-plus text-xl"></i>
        </button>
        <button onclick="openModal('EXPENSE')" class="w-14 h-14 bg-rose-500 text-white rounded-[20px] shadow-lg flex items-center justify-center active:scale-90 transition">
            <i class="fas fa-minus text-xl"></i>
        </button>
    </div>
    <button onclick="showPage('stats')" class="flex flex-col items-center text-slate-400" id="nav-stats">
        <i class="fas fa-chart-pie text-2xl"></i>
        <span class="text-[10px] font-black uppercase mt-1">–ê–Ω–∞–ª–∏–∑</span>
    </button>
</nav>

<div id="transModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="flex justify-between items-center mb-8">
            <h2 id="modalTitle" class="text-2xl font-black uppercase theme-text">–û–ø–µ—Ä–∞—Ü–∏—è</h2>
            <button onclick="closeModal()" class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center dark:text-white">‚úï</button>
        </div>
        <form id="transForm" class="space-y-6">
            <input type="hidden" id="transType">
            <input type="number" id="transAmount" class="w-full text-5xl font-black text-center bg-transparent outline-none theme-text" placeholder="0" required>

            <input type="text" id="transDesc" class="w-full modal-input p-5 rounded-2xl font-bold outline-none" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required>

            <div id="categoryContainer">
                <p class="text-[10px] font-black uppercase text-slate-400 mb-3 ml-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
                <div class="grid grid-cols-2 gap-3">
                    <label class="cursor-pointer"><input type="radio" name="cat" value="–ï–¥–∞" class="peer hidden" checked><div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl font-bold text-center peer-checked:bg-blue-600 peer-checked:text-white transition theme-text dark:text-white">üçî –ï–¥–∞</div></label>
                    <label class="cursor-pointer"><input type="radio" name="cat" value="–¢–∞–∫—Å–∏" class="peer hidden"><div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl font-bold text-center peer-checked:bg-blue-600 peer-checked:text-white transition theme-text dark:text-white">üöï –¢–∞–∫—Å–∏</div></label>
                    <label class="cursor-pointer"><input type="radio" name="cat" value="–ñ–∏–ª—å–µ" class="peer hidden"><div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl font-bold text-center peer-checked:bg-blue-600 peer-checked:text-white transition theme-text dark:text-white">üè† –ñ–∏–ª—å–µ</div></label>
                    <label class="cursor-pointer"><input type="radio" name="cat" value="–ü—Ä–æ—á–µ–µ" class="peer hidden"><div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl font-bold text-center peer-checked:bg-blue-600 peer-checked:text-white transition theme-text dark:text-white">‚ú® –ü—Ä–æ—á–µ–µ</div></label>
                </div>
            </div>

            <select id="transAccount" class="w-full modal-input p-5 rounded-2xl font-bold outline-none"></select>
            <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </form>
    </div>
</div>

<div id="accModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 class="text-2xl font-black uppercase mb-8 text-center theme-text">–ù–æ–≤—ã–π —Å—á–µ—Ç</h2>
        <form id="accForm" class="space-y-6">
            <input type="text" id="accName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞" class="w-full modal-input p-5 rounded-2xl font-bold outline-none" required>
            <input type="number" id="accGoal" placeholder="–¶–µ–ª—å (–µ—Å–ª–∏ –∫–æ–ø–∏–ª–∫–∞)" class="w-full modal-input p-5 rounded-2xl font-bold outline-none">
            <div class="grid grid-cols-4 gap-3">
                <label class="cursor-pointer"><input type="radio" name="color" value="card-gradient-1" class="peer hidden" checked><div class="h-12 rounded-xl bg-slate-800 peer-checked:ring-4 ring-blue-500"></div></label>
                <label class="cursor-pointer"><input type="radio" name="color" value="card-gradient-2" class="peer hidden"><div class="h-12 rounded-xl bg-blue-600 peer-checked:ring-4 ring-blue-500"></div></label>
                <label class="cursor-pointer"><input type="radio" name="color" value="card-gradient-3" class="peer hidden"><div class="h-12 rounded-xl bg-emerald-600 peer-checked:ring-4 ring-blue-500"></div></label>
                <label class="cursor-pointer"><input type="radio" name="color" value="card-gradient-4" class="peer hidden"><div class="h-12 rounded-xl bg-amber-500 peer-checked:ring-4 ring-blue-500"></div></label>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl">–°–û–ó–î–ê–¢–¨</button>
            <button type="button" onclick="document.getElementById('accModal').classList.add('hidden')" class="w-full text-slate-400 font-bold py-2">–û–¢–ú–ï–ù–ê</button>
        </form>
    </div>
</div>

<script>
    const API_BASE = '/api';
    let currentAccounts = [];
    let selectedAccountId = null;
    let myChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        updateDate();
        applySavedTheme();
        loadData();
        setupFormListeners();
    });

    function updateDate() {
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    async function loadData() {
        try {
            const [resAcc, resStats] = await Promise.all([
                fetch(`${API_BASE}/accounts`),
                fetch(`${API_BASE}/transactions/stats`)
            ]);
            currentAccounts = await resAcc.json();
            const stats = await resStats.json();

            renderAccounts(currentAccounts);
            updateStats(stats);
            loadTransactions();
        } catch (e) { console.error("–û—à–∏–±–∫–∞ API", e); }
    }

    function updateStats(s) {
        document.getElementById('stat-income').innerText = `+${s.monthlyIncome.toLocaleString()} –°–û–ú`;
        document.getElementById('stat-expense').innerText = `-${s.monthlyExpense.toLocaleString()} –°–û–ú`;
    }

    async function loadTransactions() {
        let url = `${API_BASE}/transactions`;
        if (selectedAccountId) url += `?accountId=${selectedAccountId}`;
        const res = await fetch(url);
        const transactions = await res.json();
        renderTransactions(transactions);
        updateChart(transactions);
    }

    function renderAccounts(accounts) {
        const container = document.getElementById('accounts-container');
        let html = accounts.map(acc => {
            const hasGoal = acc.goalAmount > 0;
            const progress = hasGoal ? Math.min((acc.balance / acc.goalAmount) * 100, 100) : 0;
            const activeClass = selectedAccountId === acc.id ? 'ring-4 ring-blue-500 ring-offset-4 dark:ring-offset-slate-900 scale-[1.02]' : 'shadow-lg';

            return `
                    <div onclick="selectAccount(${acc.id})" class="min-w-[280px] h-52 ${acc.color} rounded-[35px] p-7 flex flex-col justify-between relative snap-center cursor-pointer transition-all duration-300 ${activeClass}">
                        <button onclick="event.stopPropagation(); deleteAccount(${acc.id})" class="absolute top-6 right-6 text-white opacity-40 hover:opacity-100 text-lg transition-opacity"><i class="fas fa-trash-alt"></i></button>

                        <div>
                            <p class="text-[10px] font-black uppercase text-white/60 tracking-widest">${hasGoal ? 'üê∑ –ö–æ–ø–∏–ª–∫–∞' : '–°—á–µ—Ç'}</p>
                            <h2 class="text-3xl font-black mt-1 text-white">${acc.balance.toLocaleString()} –°–û–ú</h2>
                        </div>

                        <div class="mt-auto">
                            <p class="font-bold text-lg leading-none mb-1 text-white">${acc.name}</p>
                            ${hasGoal ? `
                                <div class="progress-bg"><div class="progress-fill" style="width: ${progress}%"></div></div>
                                <div class="flex justify-between text-[10px] font-black mt-2 text-white/70">
                                    <span>${progress.toFixed(0)}%</span>
                                    <span>–¶–µ–ª—å: ${acc.goalAmount.toLocaleString()} –°–û–ú</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
        }).join('');

        html += `
                <div onclick="openAccountModal()" class="min-w-[150px] h-52 border-4 border-dashed border-slate-300 dark:border-slate-800 rounded-[35px] flex flex-col items-center justify-center text-slate-400 hover:text-blue-500 transition-all cursor-pointer snap-center">
                    <i class="fas fa-plus-circle text-3xl mb-3"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">–ù–æ–≤—ã–π —Å—á–µ—Ç</span>
                </div>
            `;
        container.innerHTML = html;
    }

    function renderTransactions(transactions) {
        const list = document.getElementById('transactions-list');
        if (transactions.length === 0) {
            list.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold uppercase text-xs tracking-widest">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>`;
            return;
        }
        list.innerHTML = transactions.map(t => {
            const isInc = t.type === 'INCOME';
            return `
            <div class="bg-[#1E293B] p-5 rounded-[28px] flex items-center justify-between shadow-md border border-slate-700/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl ${isInc ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'} flex items-center justify-center text-lg">
                        <i class="fas ${isInc ? 'fa-arrow-up' : 'fa-shopping-bag'}"></i>
                    </div>
                    <div>
                        <p class="font-black text-sm text-fixed-white">${t.description}</p>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">${t.category || '–û–±—â–µ–µ'}</p>
                    </div>
                </div>
                <p class="font-black text-lg ${isInc ? 'text-emerald-500' : 'text-fixed-white'}">
                    ${isInc ? '+' : '-'} ${t.amount.toLocaleString()} –°–û–ú
                </p>
            </div>
        `;
        }).join('');
    }

    function updateChart(transactions) {
        const expenses = transactions.filter(t => t.type === 'EXPENSE');
        const totals = expenses.reduce((acc, t) => {
            let cat = (t.category && t.category !== "null") ? t.category : "–ü—Ä–æ—á–µ–µ";
            acc[cat] = (acc[cat] || 0) + t.amount;
            return acc;
        }, {});

        const ctx = document.getElementById('categoryChart')?.getContext('2d');
        if (!ctx) return;
        if (myChart) myChart.destroy();

        // –ú—ã —É–±—Ä–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É const isDark = ... —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(totals),
                datasets: [{
                    data: Object.values(totals),
                    backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#F43F5E', '#8B5CF6'],
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            // –§–ò–ö–°: –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ª–µ–≥–µ–Ω–¥—ã –≤—Å–µ–≥–¥–∞ –±–µ–ª—ã–π (#FFFFFF)
                            color: '#FFFFFF',
                            font: { size: 12, weight: 'bold' },
                            usePointStyle: true,
                            padding: 25
                        }
                    }
                },
                cutout: '80%'
            }
        });
    }

    function showPage(p) {
        document.getElementById('page-home').classList.toggle('hidden', p !== 'home');
        document.getElementById('page-stats').classList.toggle('hidden', p !== 'stats');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('text-blue-600'));
        document.getElementById(`nav-${p}`).classList.add('text-blue-600');
        if (p === 'stats') loadData();
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        loadData();
    }

    function applySavedTheme() {
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
    }

    function openModal(type) {
        document.getElementById('transModal').classList.remove('hidden');
        document.getElementById('transType').value = type;
        document.getElementById('modalTitle').innerText = type === 'INCOME' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–†–∞—Å—Ö–æ–¥';
        document.getElementById('categoryContainer').classList.toggle('hidden', type === 'INCOME');
        document.getElementById('transAccount').innerHTML = currentAccounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
    }

    function closeModal() { document.getElementById('transModal').classList.add('hidden'); }
    function openAccountModal() { document.getElementById('accModal').classList.remove('hidden'); }

    function selectAccount(id) {
        selectedAccountId = (selectedAccountId === id) ? null : id;
        loadData();
    }

    function setupFormListeners() {
        document.getElementById('transForm').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('transType').value;
            const data = {
                description: document.getElementById('transDesc').value,
                amount: parseFloat(document.getElementById('transAmount').value),
                type: type,
                accountId: document.getElementById('transAccount').value,
                category: type === 'EXPENSE' ? document.querySelector('input[name="cat"]:checked').value : '–î–æ—Ö–æ–¥'
            };
            await fetch(`${API_BASE}/transactions`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            closeModal(); loadData();
        };

        document.getElementById('accForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('accName').value,
                color: document.querySelector('input[name="color"]:checked').value,
                balance: 0,
                goalAmount: parseFloat(document.getElementById('accGoal').value) || 0
            };
            await fetch(`${API_BASE}/accounts`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            document.getElementById('accModal').classList.add('hidden');
            document.getElementById('accForm').reset();
            loadData();
        };
    }

    async function deleteAccount(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?")) {
            await fetch(`${API_BASE}/accounts/${id}`, { method: 'DELETE' });
            if (selectedAccountId === id) selectedAccountId = null;
            loadData();
        }
    }
</script>
</body>
</html>